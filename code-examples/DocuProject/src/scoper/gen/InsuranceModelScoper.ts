// Generated by the Freon Language Generator.
import { FreScoperBase, FreLogger, FreNode, FreNamespace, FreNodeReference } from "@freon4dsl/core";
import { AttributeRef, InsuranceProduct, Entity } from "../../language/gen/index.js";

const LOGGER = new FreLogger("InsuranceModelScoper");

/**
 * Class InsuranceModelScoper implements the scoper generated from, if present, the scoper definition,
 * otherwise this class implements the default scoper.
 */
export class InsuranceModelScoper extends FreScoperBase {
    /**
     * Returns the namespace to be used as alternative scope for 'modelelement'.
     * @param modelelement
     */
    getAlternativeScope(modelelement: FreNode): FreNamespace {
        if (!!modelelement && modelelement instanceof AttributeRef) {
            // use alternative scope 'typeof( container )'
            let owner = modelelement.freOwnerDescriptor().owner;
            if (!!owner) {
                let newScopeElement = this.myTyper.inferType(owner)?.toAstElement();
                // 'newScopeElement' could be null, when the type found by the typer does not correspond to an AST element
                if (!!newScopeElement) {
                    return FreNamespace.create(newScopeElement);
                }
            }
        }
        return null;
    }

    /**
     * Returns true if there is an alternative scope defined for this 'modelelement'.
     * @param modelelement
     */
    hasAlternativeScope(modelelement: FreNode): boolean {
        if (!!modelelement && modelelement instanceof AttributeRef) {
            return true;
        }
        return false;
    }

    /**
     * Returns all FreNodes that are defined as additional namespaces for `element'.
     * @param element
     */
    public additionalNamespaces(element: FreNode): FreNode[] {
        const result: FreNode[] = [];
        // based on namespace addition for InsuranceProduct
        if (element instanceof InsuranceProduct) {
            // generated based on 'basedOn'
            for (let loopVariable of element.basedOn) {
                if (loopVariable instanceof FreNodeReference) {
                    if (!this.currentRoleNames.includes("basedOn")) {
                        if (!!loopVariable.referred) {
                            if (!this.additionalNamespacesVisited.includes(loopVariable)) {
                                this.additionalNamespacesVisited.push(loopVariable);
                                const referred = loopVariable.referred;
                                if (!!referred) {
                                    result.push(loopVariable.referred);
                                }
                                this.additionalNamespacesVisited.pop();
                            }
                        }
                    }
                } else {
                    result.push(loopVariable);
                }
            }
        }
        // based on namespace addition for Entity
        if (element instanceof Entity) {
            // generated based on 'baseEntity'
            if (!this.currentRoleNames.includes("baseEntity")) {
                if (!!element.baseEntity) {
                    if (!this.additionalNamespacesVisited.includes(element.baseEntity)) {
                        this.additionalNamespacesVisited.push(element.baseEntity);
                        const referred = element.baseEntity.referred;
                        if (!!referred) {
                            result.push(element.baseEntity.referred);
                        }
                        this.additionalNamespacesVisited.pop();
                    }
                }
            }
        }

        return result;
    }
}
