// Generated by the ProjectIt Language Generator.
import { PiReader } from "@projectit/core";
import { net } from "net.akehurst.language-agl-processor";
import LanguageProcessor = net.akehurst.language.api.processor.LanguageProcessor;
import Agl = net.akehurst.language.agl.processor.Agl;
import AutomatonKind_api = net.akehurst.language.api.processor.AutomatonKind_api;
import { EntityModelUnitType, ModelUnitMetaType } from "../../language/gen";
import { SomeOtherModelUnitGrammarStr } from "./SomeOtherModelUnitGrammar";
import { SomeOtherModelUnitSyntaxAnalyser } from "./SomeOtherModelUnitSyntaxAnalyser";
import { EntityModelUnitGrammarStr } from "./EntityModelUnitGrammar";
import { EntityModelUnitSyntaxAnalyser } from "./EntityModelUnitSyntaxAnalyser";
import { EntitySemanticAnalyser } from "./EntitySemanticAnalyser";

/**
 *   Class EntityModelUnitReader is a wrapper for the various parsers of
 *   modelunits.
 */
export class EntityModelUnitReader implements PiReader {
    SomeOtherModelUnitParser = Agl.processorFromString(SomeOtherModelUnitGrammarStr, new SomeOtherModelUnitSyntaxAnalyser(), null, null);
    EntityModelUnitParser = Agl.processorFromString(EntityModelUnitGrammarStr, new EntityModelUnitSyntaxAnalyser(), null, null);

    /**
     * Parses and performs a syntax analysis on 'sentence', using the parser and analyser
     * for 'metatype', if available. If 'sentence' is correct, a model unit will be created,
     * otherwise an error wil be thrown containing the parse or analysis error.
     * @param sentence
     * @param metatype
     */
    readFromString(sentence: string, metatype: ModelUnitMetaType): EntityModelUnitType {
        let parser: LanguageProcessor = null;
        // choose the correct parser
        if (metatype === "SomeOtherModelUnit") {
            parser = this.SomeOtherModelUnitParser;
        }
        if (metatype === "EntityModelUnit") {
            parser = this.EntityModelUnitParser;
        }

        // parse the input
        let model: EntityModelUnitType = null;
        if (parser) {
            try {
                let sppt = parser.parse(sentence);
            } catch (e) {
                // strip the error message, otherwise it's too long for the webapp
                let mess = e.message.replace("Could not match goal,", "Parse error");
                console.log(mess);
                throw new Error(mess);
            }
            try {
                let asm = parser.process(null, sentence, AutomatonKind_api.LOOKAHEAD_1);
                model = asm as EntityModelUnitType;
                const semAnalyser = new EntitySemanticAnalyser();
                semAnalyser.correct(model);
            } catch (e) {
                console.log(e.message);
                throw e;
            }
            // reset parser
            parser = null;
        } else {
            throw new Error(`No parser for ${metatype} available: grammar incorrect.`);
        }
        return model;
    }
}
